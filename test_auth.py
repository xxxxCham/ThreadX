#!/usr/bin/env python3
"""
ThreadX Authentication Test Script
=================================

Script de test pour v√©rifier la configuration d'authentification ThreadX.
V√©rifie les variables d'environnement, teste les connexions API, et fournit
des diagnostics d√©taill√©s.

Usage:
    python test_auth.py
    python test_auth.py --verbose
    python test_auth.py --test-binance
    python test_auth.py --test-coingecko

Author: ThreadX Framework
"""

import os
import sys
import argparse
import json
from pathlib import Path

# Ajouter le chemin src pour les imports
sys.path.insert(0, str(Path(__file__).parent / "src"))

try:
    from threadx.config.auth import AuthManager, get_auth_manager
    from threadx.data.client import DataClient, get_data_client
    from threadx.config.settings import get_settings
    THREADX_AVAILABLE = True
except ImportError as e:
    print(f"‚ùå Erreur import ThreadX: {e}")
    print("üí° Assurez-vous que ThreadX est install√©: pip install -e .")
    THREADX_AVAILABLE = False


def check_environment_variables():
    """V√©rifie les variables d'environnement."""
    print("\nüîç V√âRIFICATION DES VARIABLES D'ENVIRONNEMENT")
    print("=" * 60)
    
    # Variables importantes
    important_vars = {
        'BINANCE_API_KEY': 'Cl√© API Binance',
        'BINANCE_API_SECRET': 'Secret API Binance',
        'COINGECKO_API_KEY': 'Cl√© API CoinGecko (optionnelle)',
        'ALPHA_VANTAGE_API_KEY': 'Cl√© API Alpha Vantage (optionnelle)',
        'POLYGON_API_KEY': 'Cl√© API Polygon (optionnelle)',
        'FINNHUB_API_KEY': 'Cl√© API Finnhub (optionnelle)'
    }
    
    found_vars = 0
    for var_name, description in important_vars.items():
        value = os.getenv(var_name)
        if value:
            # Masquer les cl√©s sensibles
            if len(value) > 8:
                masked_value = f"{value[:4]}...{value[-4:]}"
            else:
                masked_value = "***"
            
            print(f"‚úÖ {var_name:20s}: {masked_value} ({description})")
            found_vars += 1
        else:
            print(f"‚ùå {var_name:20s}: Non d√©finie ({description})")
    
    print(f"\nüìä R√©sum√©: {found_vars}/{len(important_vars)} variables configur√©es")
    
    # V√©rifications sp√©ciales
    binance_complete = os.getenv('BINANCE_API_KEY') and os.getenv('BINANCE_API_SECRET')
    if binance_complete:
        print("‚úÖ Configuration Binance compl√®te (cl√© + secret)")
    elif os.getenv('BINANCE_API_KEY') or os.getenv('BINANCE_API_SECRET'):
        print("‚ö†Ô∏è Configuration Binance incompl√®te (cl√© OU secret manquant)")
    else:
        print("‚ùå Configuration Binance absente")
    
    return found_vars > 0


def test_auth_manager():
    """Teste le gestionnaire d'authentification."""
    if not THREADX_AVAILABLE:
        print("‚ùå ThreadX non disponible - impossible de tester AuthManager")
        return False
    
    print("\nüîê TEST DU GESTIONNAIRE D'AUTHENTIFICATION")
    print("=" * 60)
    
    try:
        auth = get_auth_manager()
        print("‚úÖ AuthManager initialis√© avec succ√®s")
        
        # Test validation des credentials
        validation_results = auth.validate_all_credentials()
        print(f"\nüìã Validation des credentials:")
        
        for provider, is_valid in validation_results.items():
            status = "‚úÖ Valide" if is_valid else "‚ùå Invalide/Manquant"
            print(f"  - {provider.capitalize():15s}: {status}")
        
        # Test r√©cup√©ration credentials Binance
        if auth.has_binance_credentials():
            print("\nüîë Test r√©cup√©ration credentials Binance:")
            try:
                api_key, api_secret = auth.get_binance_credentials()
                print(f"  ‚úÖ API Key: {api_key[:8]}...")
                print(f"  ‚úÖ Secret: {api_secret[:8]}...")
            except Exception as e:
                print(f"  ‚ùå Erreur r√©cup√©ration: {e}")
        
        # Test URLs et rate limits
        print(f"\nüåê URLs et limites:")
        for provider in ['binance', 'coingecko']:
            url = auth.get_api_url(provider)
            rate_limit = auth.get_rate_limit(provider)
            print(f"  - {provider.capitalize():15s}: {url} ({rate_limit} req/min)")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Erreur AuthManager: {e}")
        return False


def test_data_client():
    """Teste le client de donn√©es."""
    if not THREADX_AVAILABLE:
        print("‚ùå ThreadX non disponible - impossible de tester DataClient")
        return False
    
    print("\nüì° TEST DU CLIENT DE DONN√âES")
    print("=" * 60)
    
    try:
        client = get_data_client()
        print("‚úÖ DataClient initialis√© avec succ√®s")
        
        # Test des connexions
        print("\nüß™ Test des connexions API:")
        connections = client.test_all_connections()
        
        success_count = 0
        for provider, status in connections.items():
            status_text = "‚úÖ OK" if status else "‚ùå √âchec"
            print(f"  - {provider.capitalize():15s}: {status_text}")
            if status:
                success_count += 1
        
        total_count = len(connections)
        success_rate = success_count / total_count * 100
        
        print(f"\nüìä Taux de succ√®s: {success_rate:.1f}% ({success_count}/{total_count})")
        
        return success_count > 0
        
    except Exception as e:
        print(f"‚ùå Erreur DataClient: {e}")
        return False


def test_binance_api(verbose=False):
    """Teste sp√©cifiquement l'API Binance."""
    if not THREADX_AVAILABLE:
        print("‚ùå ThreadX non disponible")
        return False
    
    print("\nüü° TEST SP√âCIFIQUE BINANCE API")
    print("=" * 60)
    
    try:
        client = get_data_client()
        
        # Test t√©l√©chargement donn√©es OHLCV
        print("üì• Test t√©l√©chargement donn√©es BTCUSDC 1d...")
        df = client.get_binance_klines("BTCUSDC", "1d", days=7)
        
        print(f"‚úÖ Donn√©es t√©l√©charg√©es: {len(df)} lignes")
        print(f"üìÖ P√©riode: {df.index[0]} ‚Üí {df.index[-1]}")
        print(f"üí∞ Prix actuel: ${df['close'].iloc[-1]:,.2f}")
        
        if verbose:
            print(f"\nüìä Aper√ßu des donn√©es:")
            print(df.head())
            
            print(f"\nüìà Statistiques:")
            print(f"  - Prix min: ${df['close'].min():,.2f}")
            print(f"  - Prix max: ${df['close'].max():,.2f}")
            print(f"  - Volume moyen: {df['volume'].mean():,.0f}")
        
        # Test ticker 24h
        print(f"\nüìä Test ticker 24h...")
        tickers = client.get_binance_24hr_ticker()
        
        print(f"‚úÖ Tickers re√ßus: {len(tickers)} symboles USDC")
        if tickers and verbose:
            print("üèÜ Top 5 par volume:")
            for i, ticker in enumerate(tickers[:5], 1):
                print(f"  {i}. {ticker['symbol']:8s} - Volume: ${ticker['volume']:,.0f}")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Erreur test Binance: {e}")
        return False


def test_coingecko_api(verbose=False):
    """Teste sp√©cifiquement l'API CoinGecko."""
    if not THREADX_AVAILABLE:
        print("‚ùå ThreadX non disponible")
        return False
    
    print("\nü¶é TEST SP√âCIFIQUE COINGECKO API")
    print("=" * 60)
    
    try:
        client = get_data_client()
        
        # Test r√©cup√©ration top coins
        print("üì• Test r√©cup√©ration top 20 coins...")
        coins = client.get_coingecko_coins(limit=20)
        
        print(f"‚úÖ Coins t√©l√©charg√©s: {len(coins)}")
        
        if verbose and coins:
            print(f"\nüèÜ Top 10 par market cap:")
            for i, coin in enumerate(coins[:10], 1):
                print(f"  {i:2d}. {coin['symbol']:8s} - {coin['name'][:20]:<20s} "
                      f"${coin['price']:>10.2f} (#{coin['market_cap_rank']})")
        
        # V√©rifier les donn√©es importantes
        btc_data = next((coin for coin in coins if coin['symbol'] == 'BTC'), None)
        if btc_data:
            print(f"\n‚Çø Bitcoin Info:")
            print(f"  - Prix: ${btc_data['price']:,.2f}")
            print(f"  - Market Cap Rank: #{btc_data['market_cap_rank']}")
            print(f"  - Volume 24h: ${btc_data['volume']:,.0f}")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Erreur test CoinGecko: {e}")
        return False


def generate_diagnostic_report():
    """G√©n√®re un rapport de diagnostic complet."""
    print("\nüìã G√âN√âRATION DU RAPPORT DE DIAGNOSTIC")
    print("=" * 60)
    
    report = {
        "timestamp": str(pd.Timestamp.now()),
        "environment": {
            "python_version": sys.version,
            "platform": sys.platform,
            "threadx_available": THREADX_AVAILABLE
        },
        "environment_variables": {},
        "authentication": {},
        "connectivity": {}
    }
    
    # Variables d'environnement
    env_vars = ['BINANCE_API_KEY', 'BINANCE_API_SECRET', 'COINGECKO_API_KEY']
    for var in env_vars:
        value = os.getenv(var)
        report["environment_variables"][var] = {
            "present": value is not None,
            "length": len(value) if value else 0
        }
    
    # Tests d'authentification
    if THREADX_AVAILABLE:
        try:
            auth = get_auth_manager()
            report["authentication"] = auth.validate_all_credentials()
        except Exception as e:
            report["authentication"]["error"] = str(e)
        
        # Tests de connectivit√©
        try:
            client = get_data_client()
            report["connectivity"] = client.test_all_connections()
        except Exception as e:
            report["connectivity"]["error"] = str(e)
    
    # Sauvegarder le rapport
    report_file = Path("threadx_diagnostic_report.json")
    with open(report_file, 'w') as f:
        json.dump(report, f, indent=2)
    
    print(f"‚úÖ Rapport sauvegard√©: {report_file}")
    return report


def main():
    """Fonction principale."""
    parser = argparse.ArgumentParser(description="Test d'authentification ThreadX")
    parser.add_argument("--verbose", "-v", action="store_true", help="Mode verbeux")
    parser.add_argument("--test-binance", action="store_true", help="Test sp√©cifique Binance")
    parser.add_argument("--test-coingecko", action="store_true", help="Test sp√©cifique CoinGecko")
    parser.add_argument("--generate-report", action="store_true", help="G√©n√©rer rapport diagnostic")
    
    args = parser.parse_args()
    
    print("üîê THREADX AUTHENTICATION TEST SCRIPT")
    print("=" * 60)
    
    # Import pandas pour les timestamps si disponible
    try:
        import pandas as pd
    except ImportError:
        print("‚ö†Ô∏è Pandas non disponible - timestamps simplifi√©s")
        pd = None
    
    # Tests de base
    env_ok = check_environment_variables()
    
    if THREADX_AVAILABLE:
        auth_ok = test_auth_manager()
        data_ok = test_data_client()
    else:
        auth_ok = data_ok = False
    
    # Tests sp√©cifiques
    if args.test_binance:
        test_binance_api(args.verbose)
    
    if args.test_coingecko:
        test_coingecko_api(args.verbose)
    
    # Rapport diagnostic
    if args.generate_report:
        generate_diagnostic_report()
    
    # R√©sum√© final
    print("\nüìä R√âSUM√â FINAL")
    print("=" * 60)
    
    if env_ok and auth_ok and data_ok:
        print("üéâ ‚úÖ Tous les tests sont pass√©s avec succ√®s!")
        print("üí° ThreadX est pr√™t √† utiliser avec authentification compl√®te.")
    elif env_ok and not THREADX_AVAILABLE:
        print("‚ö†Ô∏è Variables d'environnement configur√©es mais ThreadX non install√©")
        print("üí° Installez ThreadX: pip install -e .")
    elif not env_ok:
        print("‚ùå Variables d'environnement manquantes")
        print("üí° Consultez le fichier .env.example pour la configuration")
    else:
        print("‚ö†Ô∏è Configuration partielle d√©tect√©e")
        print("üí° V√©rifiez les messages d'erreur ci-dessus")
    
    print(f"\nüîó Liens utiles:")
    print(f"  - Configuration: .env.example")
    print(f"  - Documentation Binance: https://binance-docs.github.io/apidocs/")
    print(f"  - Documentation CoinGecko: https://www.coingecko.com/en/api/documentation")


if __name__ == "__main__":
    main()